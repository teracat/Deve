# This workflow requires the following GitHub secrets to be defined:
#
# Azure Container Registry (ACR) access:
# - ACR_LOGIN_SERVER: The login server URL of your Azure Container Registry (e.g., myregistry.azurecr.io).
# - ACR_USERNAME: The username for accessing the ACR (usually the registry name).
# - ACR_PASSWORD: The password or access key for the ACR.
#
# Azure Kubernetes Service (AKS) access:
# - AZURE_CREDENTIALS: A JSON string containing Azure service principal credentials, generated using `az ad sp create-for-rbac --sdk-auth`.
# - AKS_CLUSTER_NAME: The name of the AKS cluster to deploy to.
# - AKS_RESOURCE_GROUP: The name of the Azure resource group containing the AKS cluster.
#
# JWT Secret Keys:
# - JWT_SIGNING_SECRET_KEY: The secret key used to sign the JWT token (must be 32 bytes).
# - JWT_ENCRYPTION_SECRET_KEY: The secret key used to encrypt the JWT token (must be 32 bytes).
#
# HTTPS Certificate (PFX):
# - HTTPS_CERTIFICATE_BASE64: Contains the PFX certificate for HTTPS in Base64 format.
# - HTTPS_CERTIFICATE_PASSWORD: The password of the PFX certificate.
#
# Email notification settings:
# - SMTP_SERVER: The address of the SMTP server used to send emails.
# - SMTP_PORT: The port used by the SMTP server (e.g., 587).
# - EMAIL_USERNAME: The username of the email account used to send notifications.
# - EMAIL_PASSWORD: The password or app-specific password for the email account.
# - EMAIL_TO: The recipient email address for deployment notifications (this is a variable, not a secret).
# - EMAIL_FROM: The sender email address used in deployment notifications (this is a variable, not a secret).

name: Deploy to Azure AKS

on:
  workflow_call:
    inputs:
      environment:
        description: "The GitHub environment used to get the secrets and vars needed"
        type: string
        required: true
      solution:
        description: "The solution to build and test"
        type: string
        required: true
    secrets:
      ACR_LOGIN_SERVER:
        required: true
      ACR_USERNAME:
        required: true
      ACR_PASSWORD:
        required: true
      AZURE_CREDENTIALS:
        required: true
      AKS_CLUSTER_NAME:
        required: true
      AKS_RESOURCE_GROUP:
        required: true
      JWT_SIGNING_SECRET_KEY:
        required: true
      JWT_ENCRYPTION_SECRET_KEY:
        required: true
      HTTPS_CERTIFICATE_BASE64:
        required: true
      HTTPS_CERTIFICATE_PASSWORD:
        required: true
      SMTP_SERVER:
        required: true
      SMTP_PORT:
        required: true
      EMAIL_USERNAME:
        required: true
      EMAIL_PASSWORD:
        required: true

# Only allow one deploy per environment
concurrency: ${{ inputs.environment }}

jobs:
  build-and-test:
    uses: ./.github/workflows/build-and-test.yml    
    with:
      solution: ${{ inputs.solution }}

  deploy-azure-aks:
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs:
      build-and-test
      store-https-certificate
    env:
      AppSettings__JwtKeys__SigningSecretKey: ${{ secrets.JWT_SIGNING_SECRET_KEY }}
      AppSettings__JwtKeys__EncryptionSecretKey: ${{ secrets.JWT_ENCRYPTION_SECRET_KEY }}
      ASPNETCORE_Kestrel__Certificates__Default__Password: ${{ secrets.HTTPS_CERTIFICATE_PASSWORD }}
      ASPNETCORE_Kestrel__Certificates__Default__Path: ./certificate.pfx
    steps:
    - name: Check some secret
      run: |
          if [ -z "${{ secrets.ACR_USERNAME }}" ]; then
            echo "ACR_USERNAME is not defined"
            exit 1
          else
            echo "ACR_USERNAME is defined"
          fi

    - name: save secret to file
        run: |
          echo -n ${{ secrets.SIGNING_CERTIFICATE_BASE64 }} | base64 -d -o ./certificate.pfx

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Log in to Azure Container Registry
      uses: azure/docker-login@8e5e3c2c7e6d1f3b9a3f4f8e2c9d4a1b2e3f4c5d
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build Docker images
      run: docker compose -f ./.docker/compose.yml -f ./.docker/compose.prod.yml up --build

    - name: Push Docker images
      run: docker compose push

    - uses: azure/login@a457da9a7e3f3c2e5c3e6f1e2e8b5c6f7d8e9a0b
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set up Kubernetes
      uses: azure/aks-set-context@c7eb093e3b2a4f6d9f8e2a1c3d4b5e6f7a8b9c0d
      with:
        resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
        cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}

    - name: Deploy to AKS
      run: kubectl apply -f k8s/

    - name: Check if SMTP_SERVER is defined
      id: check_smtp
      run: |
        if [ -z "${{ secrets.SMTP_SERVER }}" ]; then
          echo "defined=false" >> $GITHUB_OUTPUT
        else
          echo "defined=true" >> $GITHUB_OUTPUT
        fi

    - name: Send Success Notification
      if: steps.check_smtp.outputs.defined == 'true' && success()
      uses: dawidd6/action-send-mail@2cea961f3b9a4e6d8c7f1e2a3b4c5d6e7f8a9b0c
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Deployment to ${{ inputs.environment }} Successful"
        body: "The deployment to ${{ inputs.environment }} has been successfully completed."
        to: ${{ vars.EMAIL_TO }}
        from: ${{ vars.EMAIL_FROM }}

    - name: Send Failure Notification
      if: steps.check_smtp.outputs.defined == 'true' && failure()
      uses: dawidd6/action-send-mail@2cea961f3b9a4e6d8c7f1e2a3b4c5d6e7f8a9b0c
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Deployment to ${{ inputs.environment }} Failed"
        body: "The deployment to ${{ inputs.environment }} has failed."
        to: ${{ vars.EMAIL_TO }}
        from: ${{ vars.EMAIL_FROM }}
